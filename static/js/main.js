// Main JavaScript for Tourism Planning Assistant

// Search History Management
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

// Popular Destinations
const popularDestinations = [
    'Paris', 'London', 'Tokyo', 'New York', 'Dubai',
    'Bangalore', 'Mumbai', 'Delhi', 'Goa', 'Jaipur'
];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function () {
    displaySearchHistory();
    displayPopularDestinations();
});

// ===== SHARE RESULTS =====
function shareResults() {
    const outputContent = document.getElementById('outputContent').innerText;
    const placeInput = document.getElementById('placeInput').value;

    const shareText = `üåç Tourism Plan for ${placeInput}\n\n${outputContent}\n\nGenerated by Tourism Planning Assistant`;

    if (navigator.share) {
        navigator.share({
            title: `Trip to ${placeInput}`,
            text: shareText
        }).catch(() => { });
    } else {
        copyToClipboard(shareText);
        showNotification('üìã Results copied to clipboard!');
    }
}

// ===== COPY TO CLIPBOARD =====
function copyResults() {
    const outputContent = document.getElementById('outputContent').innerText;
    copyToClipboard(outputContent);
    showNotification('üìã Copied to clipboard!');
}

function copyToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}

// ===== PRINT RESULTS =====
function printResults() {
    const outputContent = document.getElementById('outputContent').innerHTML;
    const placeInput = document.getElementById('placeInput').value;

    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Trip Plan - ' + placeInput + '</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;} .attraction-card{border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:8px;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h1>üåç Trip Plan: ' + placeInput + '</h1>');
    printWindow.document.write(outputContent);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

// ===== NOTIFICATION =====
function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// ===== SAVE TRIP =====
let savedTrips = JSON.parse(localStorage.getItem('savedTrips') || '[]');

function saveTrip() {
    const placeName = document.getElementById('placeInput').value;
    const outputContent = document.getElementById('outputContent').innerHTML;

    if (!placeName || !outputContent) {
        showNotification('‚ö†Ô∏è No trip to save!');
        return;
    }

    const trip = {
        id: Date.now(),
        name: placeName,
        content: outputContent,
        date: new Date().toLocaleDateString()
    };

    // Check if trip already exists
    const exists = savedTrips.some(t => t.name.toLowerCase() === placeName.toLowerCase());
    if (exists) {
        showNotification('‚ÑπÔ∏è Trip already saved!');
        return;
    }

    savedTrips.unshift(trip);
    savedTrips = savedTrips.slice(0, 10); // Keep only last 10
    localStorage.setItem('savedTrips', JSON.stringify(savedTrips));

    showNotification('üíæ Trip saved successfully!');
    displaySavedTrips();
}

function displaySavedTrips() {
    const section = document.getElementById('savedTripsSection');
    const list = document.getElementById('savedTripsList');

    if (!section || !list) return;

    if (savedTrips.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    let html = '';

    savedTrips.forEach(trip => {
        html += `
            <div class="saved-trip-item" onclick="loadTrip(${trip.id})">
                <div>
                    <div class="saved-trip-name">${trip.name}</div>
                    <div class="saved-trip-date">Saved on ${trip.date}</div>
                </div>
                <button class="delete-trip-btn" onclick="event.stopPropagation(); deleteTrip(${trip.id})">
                    üóëÔ∏è Delete
                </button>
            </div>
        `;
    });

    list.innerHTML = html;
}

function loadTrip(tripId) {
    const trip = savedTrips.find(t => t.id === tripId);
    if (!trip) return;

    document.getElementById('placeInput').value = trip.name;
    document.getElementById('outputContent').innerHTML = trip.content;
    document.getElementById('outputSection').style.display = 'block';

    // Scroll to results
    document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
    showNotification('üìÇ Trip loaded!');
}

function deleteTrip(tripId) {
    savedTrips = savedTrips.filter(t => t.id !== tripId);
    localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
    displaySavedTrips();
    showNotification('üóëÔ∏è Trip deleted!');
}

// Load saved trips on page load
document.addEventListener('DOMContentLoaded', function () {
    displaySavedTrips();
});

// Handle Enter key press in input field
document.getElementById('placeInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        searchPlace();
    }
});

// Display search history
function displaySearchHistory() {
    const historyContainer = document.getElementById('searchHistory');
    if (!historyContainer || searchHistory.length === 0) return;

    let html = '<div class="history-chips">';
    searchHistory.slice(0, 5).forEach(place => {
        html += `<span class="chip" onclick="quickSearch('${place}')">üïí ${place}</span>`;
    });
    html += '</div>';
    historyContainer.innerHTML = html;
}

// Display popular destinations
function displayPopularDestinations() {
    const popularContainer = document.getElementById('popularDestinations');
    if (!popularContainer) return;

    let html = '<div class="popular-chips">';
    popularDestinations.slice(0, 5).forEach(place => {
        html += `<span class="chip chip-popular" onclick="quickSearch('${place}')">‚ú® ${place}</span>`;
    });
    html += '</div>';
    popularContainer.innerHTML = html;
}

// Quick search from chips
function quickSearch(place) {
    document.getElementById('placeInput').value = place;
    searchPlace();
}

// Add to search history
function addToHistory(place) {
    // Remove if already exists
    searchHistory = searchHistory.filter(p => p.toLowerCase() !== place.toLowerCase());
    // Add to beginning
    searchHistory.unshift(place);
    // Keep only last 10
    searchHistory = searchHistory.slice(0, 10);
    // Save to localStorage
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    displaySearchHistory();
}

/**
 * Extract place name from natural language input
 */
function extractPlaceName(input) {
    // normalize input
    let cleanedInput = input.trim();

    // Common stop words and action phrases to remove
    const stopPhrases = [
        // Actions/Intents
        'plan a trip to', 'plan my trip to', 'plan trip to', 'plan a trip', 'plan my trip', 'plan trip',
        'i want to go to', 'i want to visit', 'i would like to visit', 'going to', 'go to',
        'show me places in', 'show places in', 'places in', 'places near', 'places at',
        'attractions in', 'attractions at', 'tourist spots in', 'tourist spots at',
        'best time to visit', 'best time for', 'timings for', 'timings of',
        'weather in', 'weather at', 'climate of', 'climate in', 'temperature in', 'temperature at',
        'guide for', 'guide to', 'itinerary for', 'itinerary to',
        'tell me about', 'information about', 'info about',
        'search for', 'find places in', 'find places',

        // Common words (if they appear at start/end or as standalone)
        'please', 'can you', 'could you', 'hey', 'hi', 'hello',
        'what is', 'where is', 'how is',
        'trip', 'tour', 'travel', 'vacation', 'holiday',
        'places', 'place', 'spots', 'spot', 'locations', 'location',
        'sightseeing', 'sights',
        'weather', 'climate', 'temperature', 'forecast',
        'near', 'nearby', 'around'
    ];

    // 1. Try specific patterns first (high confidence)
    const patterns = [
        // "Plan a trip to X"
        /(?:plan|planning)\s+(?:a|my)?\s*trip\s+(?:to|for)\s+(.+?)(?:$|[?.])/i,
        // "X plan a trip" or "X trip plan"
        /^(.+?)\s+(?:plan|planning)\s+(?:a|my)?\s*trip/i,
        // "Places to visit in X"
        /places\s+(?:to\s+visit\s+)?(?:in|at|near)\s+(.+?)(?:$|[?.])/i,
        // "Best places in X"
        /best\s+places\s+(?:in|at|near)\s+(.+?)(?:$|[?.])/i,
        // "Show me X" (if X is likely a place)
        /show\s+me\s+(?:places\s+in\s+)?(.+?)(?:$|[?.])/i,
        // "Go to X"
        /go\s+to\s+(.+?)(?:$|[?.])/i,
        // "Visit X"
        /visit\s+(.+?)(?:$|[?.])/i,
        // "X weather" or "X temperature"
        /^(.+?)\s+(?:weather|temperature|climate|forecast)/i,
        // "Weather in X"
        /(?:weather|temperature|climate|forecast)\s+(?:in|at|of|for)\s+(.+?)(?:$|[?.])/i
    ];

    for (const pattern of patterns) {
        const match = input.match(pattern);
        if (match && match[1]) {
            let candidate = match[1].trim();
            // Clean up candidate further if it contains common stop words at the end
            // e.g. "Hampi for 2 days" -> "Hampi"
            candidate = candidate.replace(/\s+(?:for|in|at|on)\s+\d+\s+(?:days|nights|weeks).*/i, '');

            // If candidate is reasonable length, return it
            if (candidate.length > 1) return candidate;
        }
    }

    // 2. Fallback: Remove known phrases and clean up
    // Sort phrases by length (descending) to remove longest matches first
    stopPhrases.sort((a, b) => b.length - a.length);

    let processed = cleanedInput.toLowerCase();

    // Remove phrases
    for (const phrase of stopPhrases) {
        // Use word boundary for short words, but loose matching for phrases
        if (phrase.includes(' ')) {
            processed = processed.replace(phrase, ' ');
        } else {
            processed = processed.replace(new RegExp(`\\b${phrase}\\b`, 'g'), ' ');
        }
    }

    // Remove special chars and extra spaces
    processed = processed.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();

    // If we have something left, return it (capitalized properly)
    if (processed.length > 1) {
        // Try to preserve original casing from input if possible, or just return what we have
        // Since we lowercased everything, let's try to map back to original input words
        const words = processed.split(' ');
        const originalWords = input.split(/\s+/);

        // Simple reconstruction attempt
        return words.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    // 3. Last resort: Return original input trimmed
    return input.trim();
}

/**
 * Detect what information user is asking for
 */
function detectIntent(input) {
    const lowerInput = input.toLowerCase();
    const wantsWeather = lowerInput.includes('temperature') ||
        lowerInput.includes('weather') ||
        lowerInput.includes('rain') ||
        lowerInput.includes('climate') ||
        lowerInput.includes('hot') ||
        lowerInput.includes('cold');
    const wantsPlaces = lowerInput.includes('place') ||
        lowerInput.includes('visit') ||
        lowerInput.includes('attraction') ||
        lowerInput.includes('plan') ||
        lowerInput.includes('trip') ||
        lowerInput.includes('go to') ||
        lowerInput.includes('going to');

    // Extract number of places if specified
    let numPlaces = 5; // Default to 5 places
    const numberMatch = input.match(/top\s+(\d+)|(\d+)\s+place/i);
    if (numberMatch) {
        numPlaces = parseInt(numberMatch[1] || numberMatch[2]);
    }

    // Check if user wants timings
    const wantsTimings = lowerInput.includes('timing') ||
        lowerInput.includes('time') ||
        lowerInput.includes('how long');

    return { wantsWeather, wantsPlaces, numPlaces, wantsTimings };
}



/**
 * Search for tourism information about a place
 */
async function searchPlace() {
    const placeInput = document.getElementById('placeInput');
    const searchBtn = document.getElementById('searchBtn');
    const btnText = document.getElementById('btnText');
    const btnLoader = document.getElementById('btnLoader');
    const outputSection = document.getElementById('outputSection');
    const outputContent = document.getElementById('outputContent');
    const errorMessage = document.getElementById('errorMessage');

    const userInput = placeInput.value.trim();

    // Validate input
    if (!userInput) {
        showError('Please enter your travel query');
        return;
    }

    // Extract place name and detect intent
    const placeName = extractPlaceName(userInput);
    const intent = detectIntent(userInput);

    // Show loading state
    searchBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-block';
    outputSection.style.display = 'none';
    errorMessage.style.display = 'none';

    try {
        // Make API request
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                place: placeName,
                limit: intent.numPlaces
            })
        });

        const data = await response.json();

        // Hide loading state
        searchBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';

        if (!data.success) {
            showError(data.error_message || data.error || 'An error occurred');
        } else {
            addToHistory(placeName);  // Save to history
            displayResults(data, placeName, intent);
        }

    } catch (error) {
        // Hide loading state
        searchBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';

        // Show error
        showError('Network error: Could not connect to the server. Please try again.');
        console.error('Error:', error);
    }
}

/**
 * Display error message
 */
function showError(message) {
    const errorMessage = document.getElementById('errorMessage');
    const outputSection = document.getElementById('outputSection');

    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
    outputSection.style.display = 'none';
}

/**
 * Display successful results in conversational format
 */
function displayResults(data, placeName, intent) {
    const errorMessage = document.getElementById('errorMessage');
    const outputSection = document.getElementById('outputSection');
    const outputContent = document.getElementById('outputContent');

    errorMessage.style.display = 'none';
    outputSection.style.display = 'block';

    let output = '';

    // Determine what to show based on user intent
    const showWeather = intent.wantsWeather;
    const showPlaces = intent.wantsPlaces;
    const cityName = data.place_info.name.split(',')[0];

    // Case 1: Places only (Example 1)
    if (showPlaces && !showWeather) {
        output += `<div class="output-intro">In <strong>${cityName}</strong> these are the places you can go,</div>`;
        output += formatAttractionsList(data.attractions);
    }
    // Case 2: Weather only (Example 2)
    else if (showWeather && !showPlaces && data.weather) {
        const weather = data.weather;
        const temp = weather.temperature;
        const rainChance = estimateRainChance(weather.weathercode);
        output += `<div class="output-intro">In <strong>${cityName}</strong> it's currently ${temp}¬∞C with a chance of ${rainChance}% to rain.</div>`;
    }
    // Case 3: Both weather and places (Example 3)
    else if (showWeather && showPlaces) {
        if (data.weather) {
            const weather = data.weather;
            const temp = weather.temperature;
            const rainChance = estimateRainChance(weather.weathercode);
            output += `<div class="output-intro">In <strong>${cityName}</strong> it's currently ${temp}¬∞C with a chance of ${rainChance}% to rain. And these are the places you can go:</div>`;
        } else {
            output += `<div class="output-intro">In <strong>${cityName}</strong> these are the places you can go,</div>`;
        }
        output += formatAttractionsList(data.attractions);
    }
    // Default: Show everything including AI features
    else {
        // Weather
        if (data.weather) {
            const weather = data.weather;
            const temp = weather.temperature;
            const rainChance = estimateRainChance(weather.weathercode);
            output += `<div class="output-intro">In <strong>${cityName}</strong> it's currently ${temp}¬∞C with a chance of ${rainChance}% to rain.</div>`;
        }

        // AI Summary
        if (data.ai_summary) {
            output += `<div class="ai-summary-box">
                <div class="ai-summary-title">‚ú® AI Summary</div>
                <p>${data.ai_summary}</p>
            </div>`;
        }

        // Attractions
        output += `<div class="output-label">Top Attractions</div>`;
        output += formatAttractionsList(data.attractions);

        // Travel Tips
        if (data.travel_tips) {
            let tipsHtml = data.travel_tips.replace(/\n/g, '<br>');
            output += `<div class="travel-tips-box">
                <div class="travel-tips-title">üí° Travel Tips</div>
                <div>${tipsHtml}</div>
            </div>`;
        }

        // Itinerary
        if (data.itinerary) {
            let itineraryHtml = data.itinerary.replace(/\n/g, '<br>');
            output += `<div class="ai-summary-box" style="border-left-color: #48bb78; background: linear-gradient(135deg, #f0fff4, #e8f5e9); margin-top: 25px;">
                <div class="ai-summary-title" style="color: #2f855a;">üìÖ Suggested Itinerary</div>
                <div>${itineraryHtml}</div>
            </div>`;
        }
    }

    outputContent.innerHTML = output;
}

/**
 * Format attractions list in simple bullet format
 */
function formatAttractionsList(attractions) {
    if (!attractions || attractions.length === 0) {
        return '<div class="output-places"><p>No tourist attractions found nearby.</p></div>';
    }

    let html = '<div class="output-places">';

    attractions.forEach((attraction) => {
        html += `<div class="attraction-card">
            <div class="attraction-info">
                <div class="attraction-name">${attraction.name || 'Unnamed Attraction'}</div>
                <div class="attraction-meta">${attraction.tourism || 'Attraction'}</div>
                ${attraction.address ? `<div class="place-address">üìç ${attraction.address}</div>` : ''}
            </div>
        </div>`;
    });

    html += '</div>';
    return html;
}

/**
 * Convert degrees to radians
 */
function toRad(degrees) {
    return degrees * (Math.PI / 180);
}


/**
 * Estimate rain chance based on weather code
 * This is a simplified estimation
 */
function estimateRainChance(weatherCode) {
    if (!weatherCode) return 0;

    // WMO Weather interpretation codes
    // 0: Clear sky
    // 1-3: Mainly clear, partly cloudy, overcast
    // 45-48: Fog
    // 51-67: Rain (various intensities)
    // 71-77: Snow
    // 80-99: Rain showers, thunderstorms

    if (weatherCode === 0) return 0;
    if (weatherCode >= 1 && weatherCode <= 3) return 10;
    if (weatherCode >= 45 && weatherCode <= 48) return 20;
    if (weatherCode >= 51 && weatherCode <= 55) return 50;
    if (weatherCode >= 56 && weatherCode <= 67) return 70;
    if (weatherCode >= 71 && weatherCode <= 77) return 30;
    if (weatherCode >= 80 && weatherCode <= 99) return 80;

    return 35; // Default
}
